<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Quant-Desk</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #121212;
            --bg-card: #1e1e1e;
            --text-primary: #e0e0e0;
            --text-secondary: #b3b3b3;
            --border-color: rgba(255, 255, 255, 0.1);
            --accent-color: #00aaff;
            --accent-green: #28a745;
            --accent-yellow: #ffc107;
            --accent-red: #e74c3c;
            --shadow-color: rgba(0, 0, 0, 0.4);
        }

        body { 
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--bg-dark); 
            color: var(--text-primary); 
            margin: 0; 
            padding: 16px; 
            line-height: 1.5;
        }

        .container { max-width: 1400px; margin: auto; }
        h1, h2 { 
            color: #ffffff; 
            font-weight: 600;
            border-bottom: 1px solid var(--border-color); 
            padding-bottom: 8px;
            margin-bottom: 16px;
        }
        h1 { font-size: 2em; }
        h2 { font-size: 1.4em; }
        p { color: var(--text-secondary); margin-bottom: 16px; }

        .overview-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); 
            gap: 12px; 
            margin-top: 16px; 
        }

        .ticker-button { 
            background-color: var(--bg-card); 
            color: var(--text-primary); 
            border: 1px solid var(--border-color); 
            padding: 8px 12px; 
            border-radius: 6px; 
            cursor: pointer; 
            text-align: center; 
            font-weight: 600; 
            font-size: 15px; 
            transition: all 0.2s ease-in-out; 
            box-shadow: 0 2px 4px var(--shadow-color);
        }
        .ticker-button:hover { 
            background-color: #2a2a2a; 
            transform: translateY(-2px); 
            border-color: var(--accent-color);
        }
        .ticker-button.active { 
            background: var(--accent-color);
            color: var(--bg-dark);
            border-color: var(--accent-color);
            transform: translateY(-1px) scale(1.02);
            box-shadow: 0 3px 6px rgba(0, 170, 255, 0.25);
        }
        .divider { border: none; border-top: 1px solid var(--border-color); margin: 32px 0; }
        #detail-view { opacity: 0; transform: translateY(15px); transition: opacity 0.4s ease, transform 0.4s ease; }
        #detail-view.visible { opacity: 1; transform: translateY(0); }
        .detail-content { display: grid; grid-template-columns: 1fr 2.5fr; gap: 16px; align-items: flex-start; }
        .card { background-color: var(--bg-card); border: 1px solid var(--border-color); border-radius: 8px; padding: 16px; box-shadow: 0 2px 5px var(--shadow-color); }
        .detail-stats { grid-column: 1 / 2; display: flex; flex-direction: column; gap: 16px;}
        .detail-chart { grid-column: 2 / 3; }
        .raw-data-section { grid-column: 1 / -1; margin-top: 16px; }

        #prediction-box { padding: 16px; border-radius: 6px; margin-bottom: 0; font-weight: 600; text-align: center; font-size: 1.15em; }
        .prediction-buy { background-color: rgba(40, 167, 69, 0.15); border: 1px solid var(--accent-green); color: var(--accent-green); }
        .prediction-hold { background-color: rgba(255, 193, 7, 0.15); border: 1px solid var(--accent-yellow); color: var(--accent-yellow); }
        .prediction-sell { background-color: rgba(231, 76, 60, 0.15); border: 1px solid var(--accent-red); color: var(--accent-red); }

        table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        th, td { text-align: left; padding: 10px 8px; border-bottom: 1px solid var(--border-color); }
        th { font-weight: 600; color: var(--text-secondary); text-transform: uppercase; font-size: 0.85em; }
        tr:last-child td { border-bottom: none; }
        td:nth-child(2) { text-align: right; font-weight: 600; color: var(--text-primary); }

        /*** TIER 2: STYLE FOR FEATURE IMPORTANCE PROGRESS BAR ***/
        .feature-importance-bar {
            background-color: var(--accent-color);
            height: 100%;
            border-radius: 3px;
            opacity: 0.7;
        }
        .feature-importance-bg {
            background-color: #333;
            border-radius: 3px;
            height: 8px;
            width: 80px; /* fixed width for alignment */
        }
        td.feature-bar-cell {
            text-align: left;
        }

        @media (max-width: 900px) {
            .detail-content { grid-template-columns: 1fr; }
            body { padding: 12px; }
            .overview-grid { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>AI Quant-Desk</h1>
        <p>Advanced market analysis powered by machine learning. This tool uses dynamic volatility targets and robust feature engineering. Click a ticker to view its detailed performance, AI signal, and the key indicators driving its decisions. ðŸŸ¢ = BUY, ðŸ”´ = SELL, ðŸŸ¡ = HOLD.</p>
        <div id="overview-grid" class="overview-grid"></div>
        <hr class="divider">
        <div id="detail-view">
            <h1 id="detail-ticker">Select a ticker to begin</h1>
            <div class="detail-content">
                <div class="detail-stats">
                    <div class="card">
                        <h2>AI Prediction</h2>
                        <div id="prediction-box">Loading...</div>
                    </div>
                    <!-- TIER 2: NEW CARD FOR MODEL EXPLAINABILITY -->
                    <div class="card">
                        <h2>Model Drivers</h2>
                        <div id="feature-importance-table"></div>
                    </div>
                    <div class="card">
                        <h2>Strategy Performance</h2>
                        <div id="summary-table"></div>
                    </div>
                </div>
                <div class="detail-chart card">
                    <h2>Price History (1Y)</h2>
                    <div id="price-chart"></div>
                </div>
                <div class="raw-data-section card">
                    <h2>Recent Market Data</h2>
                    <div id="raw-data-table"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const overviewGrid = document.getElementById('overview-grid');
            const detailView = document.getElementById('detail-view');
            const detailTicker = document.getElementById('detail-ticker');
            const predictionBox = document.getElementById('prediction-box');
            const summaryTable = document.getElementById('summary-table');
            const priceChart = document.getElementById('price-chart');
            const rawDataTable = document.getElementById('raw-data-table');
            const featureImportanceTable = document.getElementById('feature-importance-table'); // TIER 2

            let masterData = {};
            let currentTicker = null;
            
            const signalMap = {
                2: { text: 'BUY', emoji: 'ðŸŸ¢', className: 'prediction-buy' },
                1: { text: 'HOLD', emoji: 'ðŸŸ¡', className: 'prediction-hold' },
                0: { text: 'SELL', emoji: 'ðŸ”´', className: 'prediction-sell' }
            };

            fetch('data.json')
                .then(response => response.json())
                .then(data => {
                    masterData = data;
                    renderOverview();
                    if (masterData.predictions && masterData.predictions.length > 0) {
                        const firstTicker = masterData.predictions[0].Ticker;
                        updateDetailView(firstTicker);
                    }
                }).catch(error => {
                    console.error('Error loading data.json:', error);
                    detailTicker.textContent = "Error: Could not load data.json. Please run the pipeline.";
                });

            function renderOverview() {
                overviewGrid.innerHTML = '';
                masterData.predictions.forEach(p => {
                    const button = document.createElement('button');
                    button.className = 'ticker-button';
                    button.id = `btn-${p.Ticker}`;
                    const signalInfo = signalMap[p.Signal] || { emoji: 'â“' };
                    button.textContent = `${signalInfo.emoji} ${p.Ticker}`;
                    button.onclick = () => updateDetailView(p.Ticker);
                    overviewGrid.appendChild(button);
                });
            }

            function updateDetailView(ticker) {
                if (currentTicker) {
                    document.getElementById(`btn-${currentTicker}`).classList.remove('active');
                }
                document.getElementById(`btn-${ticker}`).classList.add('active');
                currentTicker = ticker;
                
                detailView.classList.add('visible');
                detailTicker.textContent = `Detailed Analysis: ${ticker}`;

                const prediction = masterData.predictions.find(p => p.Ticker === ticker);
                if (prediction) {
                    const signalInfo = signalMap[prediction.Signal] || { text: 'UNKNOWN', className: '' };
                    predictionBox.innerHTML = `<div>Signal: ${signalInfo.text}</div><div>Confidence: ${(prediction.Confidence * 100).toFixed(2)}%</div>`;
                    predictionBox.className = `prediction-box ${signalInfo.className}`;
                }

                const summary = masterData.summary[ticker];
                if (!summary) return; // Exit if no summary data

                // Update Summary Table (excluding feature importances)
                let summaryTableHTML = '<table><thead><tr><th>Metric</th><th>Value</th></tr></thead><tbody>';
                for (const [key, value] of Object.entries(summary)) {
                    if (key !== 'feature_importances') {
                        const formattedValue = typeof value === 'number' ? value.toFixed(2) : value;
                        summaryTableHTML += `<tr><td>${key}</td><td>${formattedValue}</td></tr>`;
                    }
                }
                summaryTableHTML += '</tbody></table>';
                summaryTable.innerHTML = summaryTableHTML;

                // TIER 2: Update Feature Importance Table
                let featureTableHTML = '<table><thead><tr><th>Indicator</th><th>Importance</th></tr></thead><tbody>';
                const importances = summary.feature_importances;
                if (importances && Object.keys(importances).length > 0) {
                    // Convert to array, sort, and take top 5
                    const sortedFeatures = Object.entries(importances).sort(([,a],[,b]) => b-a).slice(0, 5);
                    const maxImportance = sortedFeatures.length > 0 ? sortedFeatures[0][1] : 1;

                    sortedFeatures.forEach(([feature, value]) => {
                        const barWidth = (value / maxImportance) * 100;
                        featureTableHTML += `
                            <tr>
                                <td>${feature}</td>
                                <td class="feature-bar-cell">
                                    <div class="feature-importance-bg">
                                        <div class="feature-importance-bar" style="width: ${barWidth}%;"></div>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                } else {
                    featureTableHTML += '<tr><td colspan="2">No feature data available.</td></tr>';
                }
                featureTableHTML += '</tbody></table>';
                featureImportanceTable.innerHTML = featureTableHTML;


                const history = masterData.priceHistory[ticker];
                if (!history) {
                    priceChart.innerHTML = "No price history found for this ticker.";
                    rawDataTable.innerHTML = "";
                    return;
                }
                
                const trace = {
                    x: history.map(d => d.Date),
                    close: history.map(d => d.Close),
                    high: history.map(d => d.High),
                    low: history.map(d => d.Low),
                    open: history.map(d => d.Open),
                    type: 'candlestick', name: ticker,
                    increasing: {line: {color: 'var(--accent-green)'}}, 
                    decreasing: {line: {color: 'var(--accent-red)'}}
                };
                const layout = {
                    paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
                    font: { color: 'var(--text-primary)' },
                    xaxis: { gridcolor: 'var(--border-color)', zerolinecolor: 'var(--border-color)' },
                    yaxis: { gridcolor: 'var(--border-color)', zerolinecolor: 'var(--border-color)' },
                    margin: { l: 50, r: 20, t: 20, b: 40 }
                };
                Plotly.newPlot(priceChart, [trace], layout, {responsive: true});

                const last5Days = history.slice(-5).reverse();
                let rawDataHTML = '<table><thead><tr><th>Date</th><th>Open</th><th>High</th><th>Low</th><th>Close</th><th>Volume</th></tr></thead><tbody>';
                last5Days.forEach(d => {
                    rawDataHTML += `<tr><td>${d.Date}</td><td>${d.Open.toFixed(2)}</td><td>${d.High.toFixed(2)}</td><td>${d.Low.toFixed(2)}</td><td>${d.Close.toFixed(2)}</td><td>${d.Volume}</td></tr>`;
                });
                rawDataHTML += '</tbody></table>';
                rawDataTable.innerHTML = rawDataHTML;
            }
        });
    </script>
</body>
</html>